<html>
    <script>
        var lastTab;
        var swfList=[];
        function runBestSWF() {
            swfList.sort(function(a,b) { return b.width*b.height-a.width*a.height; });

            document.getElementById("pluginId").playSwf(swfList[0].src, swfList[0].flashVars);
            
            chrome.tabs.sendRequest(lastTab.id, {msg:"navigate", href:"http://swiffout.com/cpu-preservation.html"}, function(response) {});
        }

        chrome.browserAction.onClicked.addListener(function(tab) {            
            lastTab=tab;
            swfList=[];
            chrome.tabs.sendRequest(tab.id, {msg: "findSwf"}, function(response) {});
        });

        var TID;
        chrome.extension.onRequest.addListener(
            function(request, sender, sendResponse) {
                if(TID!=undefined) clearTimeout(TID);
                TID=setTimeout(runBestSWF, 1000);
                swfList.push(request);
            });
        
    </script>

    <embed type="application/x-swiffout" id="pluginId">
</html>
